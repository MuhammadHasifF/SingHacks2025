[{"role": "user", "content": "sup"}, {"role": "assistant", "content": "Sorry, I ran into an error processing that. Please try again.\n\n```text\n\"Input to ChatPromptTemplate is missing variables {'index=0'}.  Expected: ['history', 'index=0', 'question'] Received: ['question', 'history']\\nNote: if you intended {index=0} to be part of the string and not a variable, please escape it with double curly braces like: '{{index=0}}'.\\nFor troubleshooting, visit: https://docs.langchain.com/oss/python/langchain/errors/INVALID_PROMPT_INPUT \"\n```"}, {"role": "user", "content": "hi"}, {"role": "assistant", "content": "Sorry, I ran into an error processing that. Please try again.\n\n```text\n\"Input to ChatPromptTemplate is missing variables {'index=0'}.  Expected: ['history', 'index=0', 'question'] Received: ['question', 'history']\\nNote: if you intended {index=0} to be part of the string and not a variable, please escape it with double curly braces like: '{{index=0}}'.\\nFor troubleshooting, visit: https://docs.langchain.com/oss/python/langchain/errors/INVALID_PROMPT_INPUT \"\n```"}, {"role": "user", "content": "same error fix it:\n\n\"\"\"\nLangChain (1.x) conversational agent using Groq + RunnableWithMessageHistory.\nStrictly grounded to real insurance data (MSIG TravelEasy, Pre-Ex, Scootsurance).\nEnhanced for sales-aware behaviour: responds to user mindset, tone, urgency, hesitancy, trust concerns, decision readiness.\n\"\"\"\n\nimport os\nfrom dotenv import load_dotenv\n\nfrom langchain_groq import ChatGroq\nfrom langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder\nfrom langchain_core.output_parsers import StrOutputParser\nfrom langchain_core.chat_history import InMemoryChatMessageHistory\nfrom langchain_core.runnables import RunnableWithMessageHistory\n\n# ðŸ§  Import Hasif Logic Modules\nfrom backend.chains.question_handler import handle_question\nfrom backend.chains.citation_helper import add_citation\n\nload_dotenv()\n\ndef create_insurance_agent():\n    \"\"\"\n    Travel Insurance Chat Agent:\n      âœ… Uses Groq (LangChain)\n      âœ… Keeps per-session memory\n      âœ… Handles comparison, explanation, eligibility, scenarios\n      âœ… Cites real policy sources\n      ðŸš« Never references non-MSIG / Scootsurance products\n      ðŸŽ¯ Adapts tone & style based on userâ€™s behaviour, decision-state & emotional context.\n    \"\"\"\n\n    # 1ï¸âƒ£ Initialize Groq LLM (LangChain)\n    llm = ChatGroq(\n        model=\"llama-3.3-70b-versatile\",\n        temperature=0.4,  # warmer tone for more human-sales style\n        groq_api_key=os.getenv(\"GROQ_API_KEY\"),\n    )\n\n    # 2ï¸âƒ£ Define a rich system prompt with sales psychology\n    system_prompt = (\n        \"You are **Insurance Scammer**, an MSIG x Scootsurance insurance expert and advisor. \"\n        \"Your only knowledge sources are the following three policy documents:\\n\"\n        \"- TravelEasy Policy QTD032212\\n\"\n        \"- TravelEasy Pre-Ex Policy QTD032212-PX\\n\"\n        \"- Scootsurance QSR022206\\n\\n\"\n        \"You must never mention or recommend other insurance brands or providers. \"\n        \"When comparing or explaining, always base your response strictly on the content of these three documents. \"\n        \"Be factual and accurate, but your style should adapt to the userâ€™s mindset, emotional tone, urgency, hesitation or decision-readiness. \"\n        \"\\n\\n\"\n        \"As a sales-aware advisor you will:\\n\"\n        \"  â€¢ Recognise the userâ€™s emotional or behavioural state (e.g., unsure, confused, angry, rushed, exploratory, ready). \\n\"\n        \"  â€¢ Adjust tone accordingly: empathy for hesitancy, clarity for confusion, directness for decision-ready, brevity for urgency.\\n\"\n        \"  â€¢ Use psychological sales principles: build trust (authority, social proof), offer clarity, highlight benefits and risks, evoke appropriate urgency without pressure (scarcity, FOMO) when relevant. :contentReference[oaicite:0]{index=0}\\n\"\n        \"  â€¢ Ask guiding questions when user is uncertain; summarise and propose next-step when user is ready; acknowledge frustration when user is upset.\\n\"\n        \"  â€¢ At end of each answer include an invitation: e.g., 'Would you like me to check your eligibility next?' or 'We can compare plans side-by-side now.'\\n\"\n        \"  â€¢ If a detail is missing in the policy data, respond: 'This information is not specified in the current policy data.'\\n\"\n        \"\\n\"\n        \"Always maintain professional credibility, but speak in a friendly and human way. Use plain English, avoid heavy insurance jargon when the user seems confused. When the user is time-pressed, get to the answer quickly and follow up with a short explanation.\\n\"\n    )\n\n    prompt = ChatPromptTemplate.from_messages([\n    (\"system\", system_prompt),\n    MessagesPlaceholder(variable_name=\"history\"),\n    (\"human\", \"{question}\")\n    ])\n\n    # 3ï¸âƒ£ Build the LangChain pipeline\n    chain = prompt | llm | StrOutputParser()\n\n    # 4ï¸âƒ£ Memory setup (per session)\n    store: dict[str, InMemoryChatMessageHistory] = {}\n\n    def _get_history(session_id: str) -> InMemoryChatMessageHistory:\n        if session_id not in store:\n            store[session_id] = InMemoryChatMessageHistory()\n        return store[session_id]\n\n    chat = RunnableWithMessageHistory(\n        chain,\n        lambda session_id: _get_history(session_id),\n        input_messages_key=\"question\",\n        history_messages_key=\"history\",\n    )\n\n    # 5ï¸âƒ£ Main function: ask(...)\n    def ask(session_id: str, question: str) -> str:\n        \"\"\"\n        Handles:\n          - Intent routing via Hasifâ€™s backend logic\n          - Dynamic tone & style adaptation based on user behaviour\n          - LLM phrasing (strictly grounded to policy documents)\n          - Adds citations\n        \"\"\"\n        # Step 1 â€” Route question through logic\n        routed_answer = handle_question(question)\n\n        # Step 2 â€” Detect user behavioural & emotional state\n        lower = question.lower()\n        if any(x in lower for x in [\"i'm not sure\", \"i donâ€™t know\", \"maybe\", \"which is best\", \"help me decide\"]):\n            state_hint = \"user_unsure\"\n        elif any(x in lower for x in [\"i'm confused\", \"this is complicated\", \"i donâ€™t understand\"]):\n            state_hint = \"user_confused\"\n        elif any(x in lower for x in [\"why\", \"unfair\", \"frustrated\", \"angry\", \"hate\", \"annoyed\"]):\n            state_hint = \"user_frustrated\"\n        elif any(x in lower for x in [\"quick\", \"flight in\", \"leaving soon\", \"need this asap\", \"urgent\"]):\n            state_hint = \"user_urgent\"\n        elif any(x in lower for x in [\"iâ€™ll choose\", \"ready to buy\", \"which plan is best for me\", \"go ahead\"]):\n            state_hint = \"user_ready\"\n        elif any(x in lower for x in [\"just browsing\", \"what if\", \"how about\", \"could be\", \"explore\"]):\n            state_hint = \"user_exploratory\"\n        elif any(x in lower for x in [\"worried\", \"scared\", \"pre-existing\", \"am i covered\", \"concerned\"]):\n            state_hint = \"user_cautious\"\n        else:\n            state_hint = \"user_neutral\"\n\n        # Step 3 â€” Construct LLM input with behaviour hint\n        ai_response = chat.invoke(\n            {\n                \"question\": (\n                    f\"User asked: {question}\\n\"\n                    f\"Detected user state: {state_hint}\\n\"\n                    f\"Assistant reasoning (from JSON policies): {routed_answer}\\n\"\n                    \"Generate a clear, human-friendly, sales-aware response using ONLY these policies. \"\n                    \"Tailor your tone and style to the userâ€™s state. \"\n                    \"If unsure about a detail, say: 'This information is not specified in the current policy data.'\"\n                )\n            },\n            config={\"configurable\": {\"session_id\": session_id}},\n        )\n\n        # Step 4 â€” Add clickable citation footer\n        return add_citation(ai_response)\n\n    return ask\n"}, {"role": "assistant", "content": "Sorry, I ran into an error processing that. Please try again.\n\n```text\n\"Input to ChatPromptTemplate is missing variables {'index=0'}.  Expected: ['history', 'index=0', 'question'] Received: ['question', 'history']\\nNote: if you intended {index=0} to be part of the string and not a variable, please escape it with double curly braces like: '{{index=0}}'.\\nFor troubleshooting, visit: https://docs.langchain.com/oss/python/langchain/errors/INVALID_PROMPT_INPUT \"\n```"}, {"role": "user", "content": "hi"}, {"role": "assistant", "content": "Hello. It's great to connect with you. I'm here to help you navigate our insurance plans, specifically TravelEasy, TravelEasy Pre-Ex, and Scootsurance. We have a range of options to suit different needs. What brings you here today? Are you planning a trip or looking for insurance coverage? Perhaps you'd like to know more about how our plans can protect you against unexpected events? Would you like to explore our plans and see which one might be the best fit for you?\n\nðŸ“š **Policy Documents:**\n- [TravelEasy Policy QTD032212 (PDF)](data/Policy_Wordings\\TravelEasy%20Policy%20QTD032212.pdf)\n- [TravelEasy Pre-Ex Policy QTD032212-PX (PDF)](data/Policy_Wordings\\TravelEasy%20Pre-Ex%20Policy%20QTD032212-PX.pdf)\n- [Scootsurance QSR022206 (PDF)](data/Policy_Wordings\\Scootsurance%20QSR022206_updated.pdf)\n"}]